<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>集計演出画面</title>
  <style>
    body { margin:0; background:#111; color:#fff; font-family: system-ui, -apple-system, sans-serif; }
    .wrap { display:flex; height:100vh; }
    #img { width:45%; object-fit:cover; }
    .right { flex:1; padding:48px; display:flex; flex-direction:column; gap:18px; }
    #caption { font-size:56px; line-height:1.15; margin:0; }
    .barOuter { height:18px; background:#444; border-radius:10px; overflow:hidden; }
    #bar { height:100%; width:0%; background:#4caf50; transition: width .6s ease; }
    #percent { font-size:36px; opacity:.9; }
    #hint { font-size:16px; opacity:.65; margin-top:auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <img id="img" src="ai.png" alt="worker">
    <div class="right">
      <h1 id="caption">集計準備中…</h1>
      <div class="barOuter"><div id="bar"></div></div>
      <div id="percent">0%</div>
      <div id="hint">※この画面は投影用です（サイドバー操作で更新）</div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // GitHub Pages上の assets を基準に相対パスを補完（ai.png → https://.../ai.png）
  const BASE = 'https://kponzy.github.io/audio-assets/';

  function resolveImgSrc_(src){
    if (!src) return src;
    // すでに http(s) / data URL ならそのまま
    if (/^(https?:|data:)/i.test(src)) return src;
    // 先頭が / の場合はドメイン直下扱いになるので、基本は BASE に寄せる
    if (src.startsWith('/')) return BASE + src.replace(/^\/+/, '');
    // 相対は BASE へ
    return BASE + src;
  }

  function applyState(s){
    if (!s) return;

    if (typeof s.img === 'string') {
      $('img').src = resolveImgSrc_(s.img);
    }
    if (typeof s.caption === 'string') {
      $('caption').textContent = s.caption;
    }
    if (typeof s.progress === 'number') {
      const p = Math.max(0, Math.min(100, s.progress));
      $('bar').style.width = p + '%';
      $('percent').textContent = p + '%';
    }
  }

  // サイドバーから postMessage を受け取って更新
  window.addEventListener('message', (ev) => {
    if (!ev || !ev.data) return;

    const d = ev.data;

    // ✅新形式：{img, caption, progress} を直で送ってくる（あなたのサイドバーがこれ）
    if (typeof d === 'object' && ('img' in d || 'caption' in d || 'progress' in d)) {
      applyState(d);
      return;
    }

    // ✅旧形式：{type:'VIS_STATE', payload:{...}} にも対応（互換）
    if (d && d.type === 'VIS_STATE') {
      applyState(d.payload);
      return;
    }
  });

  // 初期表示（念のため）
  applyState({ img:'ai.png', caption:'集計準備中…', progress:0 });
</script>
</body>
</html>
